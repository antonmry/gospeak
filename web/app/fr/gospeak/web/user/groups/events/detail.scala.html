@import fr.gospeak.core.domain.{Event, Group, Proposal, User, Cfp}
@import fr.gospeak.web.domain.{Breadcrumb, HeaderInfo}
@import fr.gospeak.web.utils.Formats
@import fr.gospeak.web.partials.form.html.formBtn
@import fr.gospeak.web.partials.html.{container, pagination}
@import fr.gospeak.web.user.groups.events.routes.EventCtrl
@import fr.gospeak.web.user.groups.proposals.routes.ProposalCtrl
@import fr.gospeak.web.user.groups.proposals.speakers.routes.SpeakerCtrl
@import fr.gospeak.web.user.groups.settings.routes.SettingsCtrl
@import fr.gospeak.libs.scalautils.domain.Page

@(group: Group, event: Event, talks: Seq[Proposal], cfpOpt: Option[Cfp], proposals: Page[Proposal], speakers: Seq[User])(h: HeaderInfo, b: Breadcrumb)(implicit user: User, req: Request[AnyContent], messages: Messages, flash: Flash)
@container("Gospeak", h, Some(b))() {
    <div>
        <span class="float-right">
            <a class="btn btn-outline-secondary" href="@EventCtrl.edit(group.slug, event.slug)" title="edit">
                <i class="fas fa-edit"></i>
            </a>
        </span>
        <h1>@event.name.value</h1>
        <p>
            @Formats.datetime(event.start),
            @event.venue.map { v => @v.format, }.getOrElse{ <b class="text-danger">Missing venue</b>, }
            @event.talks.length planned talks
        </p>
    </div>

    @if(event.talks.nonEmpty) {
        <h2>@Formats.plural(event.talks.length, "planned talk")</h2>
        <ol>
        @event.talks.map { tId =>
            <li>
                @talks.find(_.id == tId).map { talk =>
                    @formBtn(EventCtrl.removeTalk(group.slug, event.slug, talk.id), Seq("class" -> "btn-link btn-sm", "title" -> "Remove this talk from the event")){<i class="fas fa-minus"></i>}
                    @formBtn(EventCtrl.moveTalk(group.slug, event.slug, talk.id, true), Seq("class" -> "btn-link btn-sm", "title" -> "Move this talk up")){<i class="fas fa-arrow-up"></i>}
                    @formBtn(EventCtrl.moveTalk(group.slug, event.slug, talk.id, false), Seq("class" -> "btn-link btn-sm", "title" -> "Move this talk down")){<i class="fas fa-arrow-down"></i>}
                    <a href="@ProposalCtrl.detail(group.slug, talk.id)">@talk.title.value</a>
                    by @talk.speakers.toList.map { sId =>
                        @speakers.find(_.id == sId).map { speaker =>
                            <a href="@SpeakerCtrl.detail(group.slug, talk.id, speaker.slug)">@speaker.name.value</a>
                        }.getOrElse { Unknown (@sId.value) }
                    }
                }.getOrElse { Unknown (@tId.value) }
            </li>
        }
        </ol>
    } else {
        <h2>No planned talks for this event</h2>
    }

    @if(cfpOpt.isEmpty) {
        <h2>CFP not activated for @group.name.value</h2>
        <p><a class="btn btn-primary" href="@SettingsCtrl.cfp(group.slug)">Enable your CFP</a> to receive talk proposals.</p>
    } else {
        @if(proposals.isEmpty) {
            <h2>No proposal for the CFP</h2>
        } else {
            <h2>@Formats.plural(proposals.total.value, "proposed talk")</h2>
            @pagination(proposals, EventCtrl.detail(group.slug, event.slug, _))
            <ul>
                @proposals.items.map { proposal =>
                    <li>
                        @formBtn(EventCtrl.addTalk(group.slug, event.slug, proposal.id), Seq("class" -> "btn-link btn-sm", "title" -> "Add this proposal to the event")){<i class="fas fa-plus"></i>}
                        (since @Formats.date(proposal.info.created))
                        <a href="@ProposalCtrl.detail(group.slug, proposal.id)">@proposal.title.value</a>
                        by @proposal.speakers.toList.map { sId =>
                            @speakers.find(_.id == sId).map { speaker =>
                            <a href="@SpeakerCtrl.detail(group.slug, proposal.id, speaker.slug)">@speaker.name.value</a>
                            }.getOrElse { Unknown (@sId.value) }
                        }
                    </li>
                }
            </ul>
            @pagination(proposals, EventCtrl.detail(group.slug, event.slug, _))
        }
    }
}()
