@import com.mohiva.play.silhouette.api.actions.SecuredRequest
@import fr.gospeak.core.domain.{Cfp, Event, Proposal, Talk, User}
@import fr.gospeak.libs.scalautils.domain.{Page, Url}
@import fr.gospeak.web.auth.domain.CookieEnv
@import fr.gospeak.web.domain.{Breadcrumb, HeaderInfo}
@import fr.gospeak.web.partials.display.html._
@import fr.gospeak.web.partials.form.html._
@import fr.gospeak.web.partials.html.securedContainer
@import fr.gospeak.web.user.talks.cfps.routes.CfpCtrl
@import fr.gospeak.web.user.talks.proposals.partials.html.{item => proposalItem}
@import fr.gospeak.web.user.talks.proposals.routes.ProposalCtrl
@import fr.gospeak.web.user.talks.routes.TalkCtrl
@import fr.gospeak.web.utils.Formats

@(talk: Talk, speakers: Seq[User], proposals: Page[(Cfp, Proposal)], events: Seq[Event], embedForm: Form[Url])(h: HeaderInfo, b: Breadcrumb)(implicit req: SecuredRequest[CookieEnv, AnyContent], messages: Messages)
@securedContainer(talk.title.value + " - Gospeak", h, Some(b))() {
    @if(talk.status == Talk.Status.Draft) {
        <div class="alert alert-info" role="alert">
            <div class="mb-0 float-right">
                @formBtn(TalkCtrl.changeStatus(talk.slug, Talk.Status.Private), Seq(
                    "class" -> "btn-sm btn-secondary",
                    "title" -> Talk.Status.Private.description,
                    "data-toggle" -> "tooltip",
                    "data-placement" -> "bottom")) {Make it private}
                @formBtn(TalkCtrl.changeStatus(talk.slug, Talk.Status.Public), Seq(
                    "class" -> "btn-sm btn-primary",
                    "title" -> Talk.Status.Public.description,
                    "data-toggle" -> "tooltip",
                    "data-placement" -> "bottom")) {Make it public}
            </div>
            <h4 class="alert-heading">Well done!</h4>
            <p class="mb-0">You created a talk, now decide if you want it to be <b>Public</b> or <b>Private</b></p>
        </div>
    }
    <div>
        <div class="float-right">
            <div class="btn-group">
                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-cog"></i>
                </button>
                <div class="dropdown-menu dropdown-menu-right">
                    <a class="dropdown-item" href="@TalkCtrl.edit(talk.slug)">Edit</a>
                    @if(talk.status != Talk.Status.Public) {
                        @formBtn(TalkCtrl.changeStatus(talk.slug, Talk.Status.Public), Seq(
                            "class" -> "dropdown-item",
                            "title" -> Talk.Status.Public.description,
                            "data-toggle" -> "tooltip",
                            "data-placement" -> "left")) {Make it public}
                    }
                    @if(talk.status != Talk.Status.Private) {
                        @formBtn(TalkCtrl.changeStatus(talk.slug, Talk.Status.Private), Seq(
                            "class" -> "dropdown-item",
                            "title" -> Talk.Status.Private.description,
                            "data-toggle" -> "tooltip",
                            "data-placement" -> "left")) {Make it private}
                    }
                    @if(talk.status != Talk.Status.Archived) {
                        @formBtn(TalkCtrl.changeStatus(talk.slug, Talk.Status.Archived), Seq(
                            "class" -> "dropdown-item",
                            "title" -> Talk.Status.Archived.description,
                            "data-toggle" -> "tooltip",
                            "data-placement" -> "left")) {Archive it}
                    }
                </div>
            </div>
        </div>
        <h1>@talk.title.value</h1>
        @duration(talk.duration) @talkStatus(talk.status)
    </div>

    <p>@markdown(talk.description)</p>

    <p>Speakers: @talk.speakers.toList.map { id => @speaker(speakers, id) }</p>

    @talk.slides.map { s => @embed(s.value) }.getOrElse {
        @formElt(embedForm, TalkCtrl.doAddSlides(talk.slug), Seq("class" -> "mb-2")) {
            @fieldHorizontal(embedForm("url"), Seq("label" -> "Slides")) { (field, _) =>
                @inputEmbed(field, Seq("placeholder" -> "Url of the slides"))
            }
            @actionsHorizontal() {
                @btnSubmit("Add slides", "btn btn-secondary")
            }
        }
    }
    @talk.video.map { v => @embed(v.value) }.getOrElse {
        @formElt(embedForm, TalkCtrl.doAddVideo(talk.slug), Seq("class" -> "mb-2")) {
            @fieldHorizontal(embedForm("url"), Seq("label" -> "Video")) { (field, _) =>
                @inputEmbed(field, Seq("placeholder" -> "Url of the video"))
            }
            @actionsHorizontal() {
                @btnSubmit("Add video", "btn btn-secondary")
            }
        }
    }

    @if(proposals.isEmpty) {
        <div class="card">
            <h5 class="card-header">Your talk was not proposed to any CFP</h5>
            <div class="card-body text-center">
                <h5 class="card-title">Well done! You have a new talk</h5>
                <p class="card-text">
                    Now find some groups to speak or make it public to receive some speaking requests
                </p>
                <a href="@CfpCtrl.list(talk.slug)" class="btn btn-success">Find a CFP to propose your talk</a>
            </div>
        </div>
    } else {
        <div class="card">
            <h5 class="card-header">
                <div class="float-right">
                    <a class="btn btn-primary btn-sm" href="@CfpCtrl.list(talk.slug)">Find a CFP to propose your talk</a>
                </div>
                You proposed your talk to @Formats.plural(proposals.total.value, "CFP"):
            </h5>
            <ul class="list-group list-group-flush">
            @proposals.items.map { case (cfp, proposal) => @proposalItem(talk, cfp, proposal, events) }
            </ul>
            @if(!proposals.isLast) {
                <div class="card-footer"><a href="@ProposalCtrl.list(talk.slug)">More...</a></div>
            }
        </div>
    }
}()
