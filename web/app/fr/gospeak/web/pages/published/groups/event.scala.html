@import fr.gospeak.core.domain.{Event, Group, Proposal, User, Comment}
@import fr.gospeak.libs.scalautils.domain.Markdown
@import fr.gospeak.web.domain.Breadcrumb
@import fr.gospeak.web.pages.partials.display.html._
@import fr.gospeak.web.pages.partials.html._
@import fr.gospeak.web.pages.published.groups.routes.GroupCtrl
@import fr.gospeak.web.pages.published.partials.html.container
@import fr.gospeak.web.pages.published.speakers.routes.SpeakerCtrl
@import fr.gospeak.web.utils.Formats
@import fr.gospeak.web.utils.UserAwareReq

@(group: Group, event: Event.Full, description: Markdown, proposals: Seq[Proposal.Full], speakers: Seq[User], comments: Seq[Comment.Full], commentForm: Form[Comment.Data], yesRsvp: Long, userRsvp: Option[Event.Rsvp], rsvps: Seq[Event.Rsvp])(b: Breadcrumb)(implicit req: UserAwareReq[AnyContent])
@container(event.name.value + " - Gospeak", b)() {
    <div class="d-flex justify-content-between align-items-center">
        <h1>@event.name.value@event.refs.meetup.map { ref => <a href="@ref.link" target="_blank"><i class="fab fa-meetup"></i></a> }</h1>
        @if(event.allowRsvp) {
            <div>
                @(event.isPast(req.now), userRsvp.map(_.answer)) match {
                    case (true, Some(Event.Rsvp.Answer.Yes)) => {You were there}
                    case (true, Some(Event.Rsvp.Answer.No)) => {Event is past}
                    case (true, Some(Event.Rsvp.Answer.Wait)) => {You were on waiting list}
                    case (true, None) => {}
                    case (false, Some(Event.Rsvp.Answer.Yes)) => {
                        @event.maxAttendee.map { nb => <b>@Formats.plural(nb - yesRsvp, "remaining place")</b> }
                        <a href="#" class="btn btn-success">Yes</a>
                        <a href="@GroupCtrl.doRsvp(group.slug, event.slug, Event.Rsvp.Answer.No)" class="btn btn-secondary">No</a>
                    }
                    case (false, Some(Event.Rsvp.Answer.No)) => {
                        @event.maxAttendee.map { nb => <b>@Formats.plural(nb - yesRsvp, "remaining place")</b> }
                        <a href="@GroupCtrl.doRsvp(group.slug, event.slug, Event.Rsvp.Answer.Yes)" class="btn btn-secondary">Yes</a>
                        <a href="#" class="btn btn-danger">No</a>
                    }
                    case (false, Some(Event.Rsvp.Answer.Wait)) => {
                        <b>No remaining place</b>
                        <a href="#" class="btn btn-primary">Waiting list</a>
                        <a href="@GroupCtrl.doRsvp(group.slug, event.slug, Event.Rsvp.Answer.No)" class="btn btn-secondary">No</a>
                    }
                    case (false, None) => {
                        @event.maxAttendee.map { nb => <b>@Formats.plural(nb - yesRsvp, "remaining place")</b> }
                        <a href="@GroupCtrl.doRsvp(group.slug, event.slug, Event.Rsvp.Answer.Yes)" class="btn btn-primary">Yes</a>
                        <a href="@GroupCtrl.doRsvp(group.slug, event.slug, Event.Rsvp.Answer.No)" class="btn btn-primary">No</a>
                    }
                }
            </div>
        }
    </div>

    <div class="row">
        <div class="col-9">
            @markdown(description)
        </div>
        <div class="col">
            <p>
                <i class="fas fa-calendar-day"></i> @Formats.dateFull(event.start)<br>
                <i class="fas fa-clock"></i> @Formats.time(event.start)
            </p>
            @event.venue.map { v =>
                <p>
                    <i class="fas fa-map-marker-alt"></i> <b>@v.partner.name.value</b><br>
                    @address(v.address)
                </p>
            }
            @if(event.allowRsvp) {
                <p><i class="fas fa-users"></i> @yesRsvp people reserved their seat</p>
                @if(rsvps.nonEmpty) {
                    @rsvps.sortBy(_.answer).map { rsvp =>
                        <div class="d-flex justify-content-between align-items-center">
                            <span><img src="@rsvp.user.avatar.url.value" alt="" class="avatar"/> @rsvp.user.name.value</span>
                            @rsvp.answer match {
                                case Event.Rsvp.Answer.Yes => {<span class="badge badge-success">Yes</span>}
                                case Event.Rsvp.Answer.No => {<span class="badge badge-danger">No</span>}
                                case Event.Rsvp.Answer.Wait => {<span class="badge badge-secondary">List d'attente</span>}
                            }
                        </div>
                    }
                }
            }
        </div>
    </div>

    @if(event.talks.nonEmpty) {
        <div class="row">
            <div class="col">
                @event.talks.toList.flatMap(id => proposals.find(_.id == id)).map { talk =>
                    <div class="card mb-3">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <a href="@GroupCtrl.talk(group.slug, talk.id)">@talk.title.value</a>
                                <small>@talk.speakers.toList.map { id => @speaker(speakers, id, s => Some(SpeakerCtrl.detail(s.slug)).filter(_ => s.isPublic)) }</small>
                            </h5>
                            <span>
                                @slidesIcon(talk.slides)
                                @videoIcon(talk.video)
                            </span>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <div class="row">
        <div class="col">
            @commentSection(comments, commentForm, GroupCtrl.doSendComment(group.slug, event.slug), GroupCtrl.event(group.slug, event.slug))
        </div>
    </div>
}()
